<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleek Glassmorphic Invoicing</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Load HTML2Canvas for Image/PNG Generation -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* Custom Dark Mode & Glassmorphism Styling */
        :root {
            --primary-color: #3b82f6; /* Tailwind Blue-500 */
            --dark-blue-theme: #172554; /* Custom Dark Blue */
            --text-color: #e5e7eb;
            --bg-color: #030712; /* Darkest Gray */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .glass-card {
            background-color: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }

        .glass-input {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 10px;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        .glass-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        /* Dark Mode overrides for elements inside the glass */
        .glass-card * {
            color: var(--text-color);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="app" class="flex flex-col flex-grow">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, where, getDocs, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App Variables (MUST be present for Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Defensive Firebase Configuration Setup ---

        // This safe config is used if environment variables fail, guaranteeing the required fields exist.
        const SAFE_CONFIG = {
            apiKey: "placeholder", 
            authDomain: "placeholder.firebaseapp.com",
            projectId: "placeholder-project-id", // GUARANTEED to be present
            storageBucket: "placeholder.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef1234567890"
        };
        
        /**
         * Safely retrieves the Firebase configuration, using environment variables
         * if available and valid, otherwise falling back to the SAFE_CONFIG.
         */
        const getFirebaseConfig = () => {
            try {
                const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                
                // Check if string exists and looks like valid JSON object start
                if (configString && configString.trim().startsWith('{')) {
                    const parsedConfig = JSON.parse(configString);
                    // Merge environment config with SAFE_CONFIG to ensure ALL keys are present
                    return { ...SAFE_CONFIG, ...parsedConfig };
                }
            } catch (e) {
                console.warn("Could not parse __firebase_config, falling back to safe default.", e);
            }
            console.log("Using SAFE_CONFIG for Firebase initialization.");
            return SAFE_CONFIG;
        };

        const firebaseConfig = getFirebaseConfig();
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- End of Defensive Firebase Configuration Setup ---


        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- Application State ---
        const state = {
            currentView: 'LOADING', // LOADING, ONBOARDING, EDITOR, DASHBOARD, HISTORY
            settings: null, // Stores user settings and company profile
            clients: [],
            invoices: [],
            currentInvoice: null,
            modal: {
                isVisible: false,
                title: '',
                message: ''
            }
        };

        // --- Utility Functions ---

        /** Generates a random, unique Invoice ID based on the current year. */
        const generateInvoiceId = (invoices) => {
            const year = new Date().getFullYear();
            const count = invoices.filter(inv => inv.invoiceId.startsWith(`INV-${year}`)).length + 1;
            return `INV-${year}-${String(count).padStart(4, '0')}`;
        };

        /** Calculates all financial totals for the current invoice. */
        const calculateTotals = (invoice) => {
            const items = invoice.items || [];
            let subtotal = 0;
            
            items.forEach(item => {
                const total = (parseFloat(item.quantity) || 0) * (parseFloat(item.unitPrice) || 0);
                item.lineTotal = parseFloat(total.toFixed(2));
                subtotal += total;
            });
            
            const taxRate = parseFloat(invoice.totals.taxRate) || 0;
            const discountAmount = parseFloat(invoice.totals.discountAmount) || 0;

            let taxableBase = subtotal - discountAmount;
            if (taxableBase < 0) taxableBase = 0;

            const taxAmount = parseFloat((taxableBase * taxRate).toFixed(2));
            const grandTotal = parseFloat((subtotal - discountAmount + taxAmount).toFixed(2));

            invoice.totals = {
                ...invoice.totals,
                subtotal: parseFloat(subtotal.toFixed(2)),
                taxAmount: taxAmount,
                grandTotal: grandTotal,
            };
        };

        /** Resets and initializes a new invoice object. */
        const newInvoice = () => {
            const inv = {
                invoiceId: 'NEW_DRAFT',
                status: 'Draft',
                dateIssued: new Date().toISOString().substring(0, 10),
                dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().substring(0, 10), // Net 30 default
                currency: state.settings?.defaultCurrency || 'USD',
                paymentTerms: state.settings?.defaultPaymentTerms || 'Net 30',
                client: {},
                sender: state.settings?.companyProfile || {},
                items: [{ itemId: 1, description: '', quantity: 1, unit: 'Units', unitPrice: 0.00, lineTotal: 0.00 }],
                totals: {
                    subtotal: 0.00,
                    discountAmount: 0.00,
                    taxRate: state.settings?.defaultTaxRate || 0.00,
                    taxAmount: 0.00,
                    grandTotal: 0.00,
                },
                design: {
                    templateStyle: 'Glassmorphism', 
                    themeColor: 'Dark Blue', 
                    mode: 'Dark'
                },
                notes: state.settings?.defaultNotes || 'Thank you for your business!',
                paymentInstructions: state.settings?.paymentDetails || '',
            };
            calculateTotals(inv);
            return inv;
        };

        /** Shows a custom modal message */
        const showModal = (title, message) => {
            state.modal = { isVisible: true, title, message };
            updateUI();
        };

        // --- Firebase Data Interaction ---
        
        const getSettingsDocRef = () => doc(db, 'artifacts', appId, 'users', userId, 'settings', 'profile');
        const getInvoicesCollectionRef = () => collection(db, 'artifacts', appId, 'users', userId, 'invoices');

        /** Saves the user's settings (used in Onboarding and Settings page) */
        const saveSettings = async (settingsData) => {
            if (!userId) return showModal('Error', 'User not authenticated. Cannot save settings.');
            try {
                await setDoc(getSettingsDocRef(), settingsData, { merge: true });
                state.settings = settingsData;
                showModal('Success', 'Settings saved successfully!');
            } catch (error) {
                console.error("Error saving settings:", error);
                showModal('Error', `Failed to save settings: ${error.message}`);
            }
        };

        /** Saves a single invoice document (used in Editor) */
        const saveInvoice = async (invoiceData, options = { final: false }) => {
            if (!userId) return showModal('Error', 'User not authenticated. Cannot save invoice.');
            
            try {
                // If it's a new final invoice, generate the final ID
                if (options.final && invoiceData.invoiceId === 'NEW_DRAFT') {
                    invoiceData.invoiceId = generateInvoiceId(state.invoices);
                    invoiceData.status = 'Sent'; // Automatically mark as sent when finalizing
                }

                if (invoiceData.docId) {
                    const docRef = doc(getInvoicesCollectionRef(), invoiceData.docId);
                    await updateDoc(docRef, invoiceData);
                } else {
                    const docRef = await addDoc(getInvoicesCollectionRef(), invoiceData);
                    invoiceData.docId = docRef.id;
                }
                
                showModal('Success', `Invoice ${invoiceData.invoiceId} saved.`);
                state.currentInvoice = invoiceData;

                // Move to History view on final save
                if (options.final) {
                    state.currentView = 'HISTORY';
                }

                updateUI();
            } catch (error) {
                console.error("Error saving invoice:", error);
                showModal('Error', `Failed to save invoice: ${error.message}`);
            }
        };


        // --- Firebase Initialization & Authentication ---

        const initializeFirebase = async () => {
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Use session persistence to maintain auth state across tab closing
                await setPersistence(auth, browserSessionPersistence);

                // Sign in using custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization or auth error:", error);
                // Display clearer error message advising a refresh
                showModal('Initialization Failed', 
                    `Error: ${error.message}. This usually means the environment variables failed to load. Please try refreshing the entire page to reset the connection.`
                );
            }
        };

        const setupListeners = () => {
            // 1. Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                userId = user ? user.uid : (typeof crypto !== 'undefined' ? crypto.randomUUID() : 'temp-id');
                isAuthReady = true;

                // 2. Settings Listener
                onSnapshot(getSettingsDocRef(), (doc) => {
                    const settingsData = doc.data();
                    state.settings = settingsData;
                    
                    // Determine initial view only if state is LOADING
                    if (state.currentView === 'LOADING') {
                        if (!settingsData || !settingsData.companyProfile) {
                            state.currentView = 'ONBOARDING';
                        } else {
                            state.currentView = 'DASHBOARD';
                        }
                    }
                    updateUI();
                }, (error) => {
                    console.error("Error fetching settings:", error);
                });

                // 3. Invoices Listener
                onSnapshot(query(getInvoicesCollectionRef()), (snapshot) => {
                    state.invoices = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    // Only updateUI if we are on a relevant view (not the initial load)
                    if (state.currentView !== 'LOADING') updateUI();
                }, (error) => {
                    console.error("Error fetching invoices:", error);
                });
            });
        };

        // --- View Rendering Logic ---

        const renderNav = () => {
            const navItems = [
                { id: 'DASHBOARD', icon: 'fa-house', label: 'Dashboard' },
                { id: 'HISTORY', icon: 'fa-file-invoice', label: 'Invoices' },
                { id: 'CLIENTS', icon: 'fa-user-group', label: 'Clients' },
                { id: 'SETTINGS', icon: 'fa-gear', label: 'Settings' }
            ];
            
            // Render the Nav Bar for the main application
            return `
                <nav class="glass-card flex justify-between items-center p-4 sticky top-0 z-50 rounded-none rounded-b-xl">
                    <div class="flex items-center space-x-2">
                        <i class="fa-solid fa-gem text-lg text-blue-400"></i>
                        <span class="text-xl font-bold">Invoicify</span>
                    </div>
                    <div class="hidden md:flex space-x-4">
                        ${navItems.map(item => `
                            <button onclick="changeView('${item.id}')" class="flex items-center space-x-2 p-2 rounded-lg transition ${state.currentView === item.id ? 'bg-blue-800/50 text-white' : 'hover:bg-white/10 text-gray-300'}">
                                <i class="fa-solid ${item.icon}"></i>
                                <span>${item.label}</span>
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="startNewInvoice()" class="btn-primary flex items-center space-x-2">
                        <i class="fa-solid fa-plus"></i>
                        <span class="hidden sm:inline">Create Invoice</span>
                    </button>
                </nav>
            `;
        };

        const renderOnboarding = () => {
            return `
                <div class="flex flex-col items-center justify-center flex-grow p-4">
                    <div class="glass-card p-8 w-full max-w-lg space-y-6">
                        <h2 class="text-3xl font-extrabold text-white text-center">Welcome Aboard!</h2>
                        <p class="text-center text-gray-300">Let's set up your company profile to start invoicing.</p>
                        
                        <form id="onboarding-form" class="space-y-4">
                            <div>
                                <label for="companyName" class="block text-sm font-medium text-gray-300">Company Name</label>
                                <input type="text" id="onboard_companyName" required placeholder="Doe Designs Inc." class="glass-input w-full mt-1">
                            </div>
                            <div>
                                <label for="logoUrl" class="block text-sm font-medium text-gray-300">Company Logo URL (Placeholder)</label>
                                <input type="text" id="onboard_logoUrl" placeholder="https://placehold.co/150x50/3b82f6/white?text=LOGO" class="glass-input w-full mt-1">
                            </div>
                            <div>
                                <label for="defaultCurrency" class="block text-sm font-medium text-gray-300">Default Currency</label>
                                <select id="onboard_defaultCurrency" class="glass-input w-full mt-1">
                                    <option value="USD">USD ($)</option>
                                    <option value="EUR">EUR (€)</option>
                                    <option value="GBP">GBP (£)</option>
                                </select>
                            </div>
                            <div>
                                <label for="paymentDetails" class="block text-sm font-medium text-gray-300">Payment Details (Bank Info, etc.)</label>
                                <textarea id="onboard_paymentDetails" rows="3" placeholder="Bank Name: XYZ, Account: 123456" class="glass-input w-full mt-1"></textarea>
                            </div>
                            
                            <button type="submit" class="btn-primary w-full mt-6">Finish Setup & Go to Dashboard</button>
                        </form>
                    </div>
                </div>
            `;
        };
        
        const renderInvoicePreview = (invoice) => {
            const { companyProfile } = state.settings || {};
            const { design } = invoice;

            let cardClass = 'glass-card border-2';
            let colorClass = design.themeColor === 'Dark Blue' ? 'bg-blue-950/20 text-gray-200' : 'bg-red-900/20 text-gray-200';
            
            // Customize based on templateStyle
            if (design.templateStyle === 'Glassmorphism') {
                cardClass = 'glass-card p-8 shadow-xl';
            } else if (design.templateStyle === 'Modern') {
                cardClass = 'bg-white/10 p-8 shadow-2xl';
            } else if (design.templateStyle === 'Sleek') {
                cardClass = 'bg-gray-900/50 p-6 shadow-lg border-l-4 border-blue-400';
            }

            return `
                <div class="h-full overflow-y-auto p-4 md:p-8">
                    <div id="invoice-template-area" class="${cardClass} ${colorClass} mx-auto w-full max-w-3xl min-h-[800px] print:p-0">
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-10 border-b border-white/10 pb-4">
                            <div>
                                <h1 class="text-4xl font-bold text-white mb-2">INVOICE</h1>
                                <p class="text-gray-400">#${invoice.invoiceId === 'NEW_DRAFT' ? 'DRAFT - PENDING ID' : invoice.invoiceId}</p>
                                <p class="text-sm text-gray-500 mt-1">Status: <span class="${invoice.status === 'Sent' ? 'text-blue-400' : invoice.status === 'Draft' ? 'text-yellow-400' : 'text-green-400'} font-semibold">${invoice.status}</span></p>
                            </div>
                            <div class="text-right">
                                ${companyProfile?.logoUrl ? `<img src="${companyProfile.logoUrl}" alt="Logo" class="h-10 mb-2 inline-block">` : `<span class="text-xl font-extrabold text-blue-400">${companyProfile?.companyName || 'YOUR COMPANY'}</span>`}
                                <p class="text-sm text-gray-400">${companyProfile?.companyName || ''}</p>
                            </div>
                        </div>

                        <!-- Details & Client Info -->
                        <div class="grid grid-cols-2 gap-4 mb-10 text-sm">
                            <div>
                                <h3 class="font-semibold text-gray-300 uppercase mb-1">Billed To:</h3>
                                <p class="font-medium">${invoice.client.companyName || 'Select/Enter Client'}</p>
                                <p class="text-gray-400">${invoice.client.contactPerson || ''}</p>
                                <p class="text-gray-400">${invoice.client.address?.street || ''}</p>
                                <p class="text-gray-400">${invoice.client.address?.city || ''}</p>
                            </div>
                            <div class="text-right">
                                <p><span class="font-semibold">Issue Date:</span> ${invoice.dateIssued || 'N/A'}</p>
                                <p><span class="font-semibold">Due Date:</span> ${invoice.dueDate || 'N/A'}</p>
                                <p><span class="font-semibold">Payment Terms:</span> ${invoice.paymentTerms}</p>
                            </div>
                        </div>

                        <!-- Line Items Table -->
                        <div class="mb-10">
                            <table class="w-full text-left text-sm">
                                <thead class="border-b border-white/20 uppercase text-gray-400">
                                    <tr>
                                        <th class="py-2">Description</th>
                                        <th class="py-2 text-right">Qty</th>
                                        <th scope="col" class="px-6 py-3">Unit Price</th>
                                        <th class="py-2 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoice.items.map(item => `
                                        <tr class="border-b border-white/5">
                                            <td class="py-2 font-medium">${item.description || 'Service Description'}</td>
                                            <td class="py-2 text-right">${item.quantity} ${item.unit}</td>
                                            <td class="py-2 text-right">${invoice.currency} ${item.unitPrice.toFixed(2)}</td>
                                            <td class="py-2 text-right font-medium">${invoice.currency} ${item.lineTotal.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Totals & Notes -->
                        <div class="flex justify-end">
                            <div class="w-full max-w-sm">
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Subtotal:</span>
                                        <span class="font-medium">${invoice.currency} ${invoice.totals.subtotal.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Discount:</span>
                                        <span class="font-medium">${invoice.currency} ${invoice.totals.discountAmount.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Tax (${(invoice.totals.taxRate * 100).toFixed(0)}%):</span>
                                        <span class="font-medium">${invoice.currency} ${invoice.totals.taxAmount.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between pt-3 border-t border-white/20 text-lg font-bold">
                                        <span>GRAND TOTAL:</span>
                                        <span class="text-blue-400">${invoice.currency} ${invoice.totals.grandTotal.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="mt-10 pt-6 border-t border-white/10 text-sm">
                            <h3 class="font-semibold text-gray-300 uppercase mb-2">Notes:</h3>
                            <p class="text-gray-400 mb-4">${invoice.notes}</p>
                            <h3 class="font-semibold text-gray-300 uppercase mb-2">Payment Instructions:</h3>
                            <p class="text-gray-400">${invoice.paymentInstructions}</p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderEditor = () => {
            const invoice = state.currentInvoice;
            if (!invoice) return ``;

            // Function to add a new blank line item
            const addItem = () => {
                const newItem = {
                    itemId: Date.now(), // Use timestamp for a unique key in the session
                    description: '', quantity: 1, unit: 'Units', unitPrice: 0.00, lineTotal: 0.00
                };
                invoice.items.push(newItem);
                calculateTotals(invoice);
                updateUI();
            };

            // Function to handle changes to line items
            const handleItemChange = (itemId, field, value) => {
                const item = invoice.items.find(i => i.itemId == itemId);
                if (item) {
                    item[field] = field === 'description' || field === 'unit' ? value : parseFloat(value) || 0;
                    calculateTotals(invoice);
                    updateUI();
                }
            };

            // Function to remove a line item
            const removeItem = (itemId) => {
                invoice.items = invoice.items.filter(i => i.itemId != itemId);
                calculateTotals(invoice);
                updateUI();
            };

            // Attach listeners for dynamic element manipulation
            setTimeout(() => {
                document.getElementById('add-item-btn')?.addEventListener('click', addItem);
                
                // Set up event listeners for line items
                document.querySelectorAll('.line-item-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const [field, itemId] = e.target.id.split('_');
                        handleItemChange(itemId, field, e.target.value);
                    });
                });

                document.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Use dataset to get the itemid reliably
                        const itemId = e.target.dataset.itemid || e.target.closest('button')?.dataset.itemid;
                        if (itemId) removeItem(itemId);
                    });
                });

                // Set up listeners for design controls
                document.getElementById('design-controls')?.addEventListener('click', (e) => {
                    if (e.target.dataset.template) {
                        invoice.design.templateStyle = e.target.dataset.template;
                        updateUI();
                    } else if (e.target.dataset.theme) {
                        invoice.design.themeColor = e.target.dataset.theme;
                        updateUI();
                    } else if (e.target.dataset.mode) {
                        invoice.design.mode = e.target.dataset.mode;
                        // Note: A full light/dark mode switch would require changing the body class
                        updateUI();
                    }
                });

                // Set up listeners for core data
                document.getElementById('core-data-form')?.addEventListener('input', (e) => {
                    const field = e.target.id;
                    if (field.startsWith('client_')) {
                        const clientField = field.substring(7);
                        if (!invoice.client.address) invoice.client.address = {};
                        if (clientField === 'street' || clientField === 'city') {
                            invoice.client.address[clientField] = e.target.value;
                        } else {
                            invoice.client[clientField] = e.target.value;
                        }
                    } else if (field.startsWith('totals_')) {
                        // Special handling for percentage input (Tax Rate)
                        if (field === 'totals_taxRate') {
                            invoice.totals[field.substring(7)] = (parseFloat(e.target.value) / 100) || 0;
                        } else {
                            invoice.totals[field.substring(7)] = parseFloat(e.target.value) || 0;
                        }
                        calculateTotals(invoice);
                    } else {
                        invoice[field] = e.target.value;
                    }
                    updateUI();
                });

                // Attach Download & Save Handlers
                document.getElementById('download-pdf-btn')?.addEventListener('click', () => showModal('PDF Generation', 'PDF generation would typically occur server-side or via a library like jsPDF. For now, this is a placeholder.'));
                document.getElementById('download-image-btn')?.addEventListener('click', generateImage);
                document.getElementById('save-draft-btn')?.addEventListener('click', () => saveInvoice(invoice, { final: false }));
                document.getElementById('finalize-send-btn')?.addEventListener('click', () => saveInvoice(invoice, { final: true }));


            }, 0); // Run after UI update

            // Line Item Editor Structure
            const lineItemRows = invoice.items.map(item => `
                <div class="grid grid-cols-6 gap-3 mb-2 items-center">
                    <input type="text" id="description_${item.itemId}" value="${item.description}" placeholder="Description" class="line-item-input glass-input col-span-2">
                    <input type="text" id="unit_${item.itemId}" value="${item.unit}" placeholder="Unit (e.g., Hrs)" class="line-item-input glass-input">
                    <input type="number" id="quantity_${item.itemId}" value="${item.quantity}" min="0" class="line-item-input glass-input">
                    <input type="number" id="unitPrice_${item.itemId}" value="${item.unitPrice}" min="0" step="0.01" class="line-item-input glass-input">
                    <div class="text-right font-medium">${invoice.currency} ${item.lineTotal.toFixed(2)}</div>
                    <button type="button" data-itemid="${item.itemId}" class="remove-item-btn text-red-400 hover:text-red-500 transition"><i data-itemid="${item.itemId}" class="fa-solid fa-trash-can"></i></button>
                </div>
            `).join('');


            // Editor UI Layout (Grid: Controls/Data on Left, Preview on Right)
            return `
                <div class="flex flex-grow overflow-hidden">
                    <!-- Left Sidebar: Controls & Data Entry -->
                    <div class="w-full md:w-1/2 overflow-y-auto p-4 md:p-8 space-y-8">
                        
                        <!-- 1. Design Controls -->
                        <div id="design-controls" class="glass-card p-4 space-y-4">
                            <h3 class="text-xl font-semibold border-b border-white/10 pb-2 mb-4">Design & Theme</h3>
                            
                            <p class="font-medium text-gray-300">Style:</p>
                            <div class="flex space-x-2">
                                ${['Glassmorphism', 'Modern', 'Sleek'].map(t => `
                                    <button data-template="${t}" class="p-2 rounded-lg text-sm transition ${invoice.design.templateStyle === t ? 'bg-blue-600' : 'bg-white/10 hover:bg-white/20'}">${t}</button>
                                `).join('')}
                            </div>

                            <p class="font-medium text-gray-300 pt-3">Theme Color:</p>
                            <div class="flex space-x-3">
                                <button data-theme="Dark Blue" class="w-8 h-8 rounded-full bg-blue-900 border-2 ${invoice.design.themeColor === 'Dark Blue' ? 'border-blue-400' : 'border-transparent'} transition"></button>
                                <button data-theme="Red" class="w-8 h-8 rounded-full bg-red-900 border-2 ${invoice.design.themeColor === 'Red' ? 'border-red-400' : 'border-transparent'} transition"></button>
                            </div>
                        </div>

                        <form id="core-data-form" class="space-y-6">
                            
                            <!-- 2. Client & Core Info -->
                            <div class="glass-card p-4 space-y-4">
                                <h3 class="text-xl font-semibold border-b border-white/10 pb-2">Client Details</h3>
                                <input type="text" id="client_companyName" value="${invoice.client.companyName || ''}" placeholder="Client Company Name" class="glass-input w-full">
                                <input type="text" id="client_contactPerson" value="${invoice.client.contactPerson || ''}" placeholder="Contact Person" class="glass-input w-full">
                                <input type="date" id="dateIssued" value="${invoice.dateIssued}" class="glass-input w-full">
                                <input type="date" id="dueDate" value="${invoice.dueDate}" class="glass-input w-full">
                            </div>

                            <!-- 3. Line Items Editor -->
                            <div class="glass-card p-4 space-y-4">
                                <h3 class="text-xl font-semibold border-b border-white/10 pb-2">Work Items</h3>
                                <div class="grid grid-cols-6 gap-3 mb-2 font-semibold text-sm text-gray-400">
                                    <div class="col-span-2">Description</div>
                                    <div>Unit</div>
                                    <div>Qty</div>
                                    <div>Price</div>
                                    <div class="text-right">Total</div>
                                    <div></div>
                                </div>
                                ${lineItemRows}
                                <button type="button" id="add-item-btn" class="flex items-center space-x-1 text-blue-400 hover:text-blue-500 transition">
                                    <i class="fa-solid fa-circle-plus"></i> <span>Add Work Item</span>
                                </button>
                            </div>
                            
                            <!-- 4. Totals & Notes -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="glass-card p-4 space-y-2">
                                    <h3 class="text-xl font-semibold border-b border-white/10 pb-2">Financials</h3>
                                    <label class="block text-sm font-medium">Discount Amount (${invoice.currency})</label>
                                    <input type="number" id="totals_discountAmount" value="${invoice.totals.discountAmount}" step="0.01" min="0" class="glass-input w-full">
                                    <label class="block text-sm font-medium">Tax Rate (%)</label>
                                    <input type="number" id="totals_taxRate" value="${(invoice.totals.taxRate * 100).toFixed(0)}" min="0" max="100" class="glass-input w-full">
                                    <div class="pt-2 border-t border-white/10 text-lg font-bold">
                                        Grand Total: ${invoice.currency} ${invoice.totals.grandTotal.toFixed(2)}
                                    </div>
                                </div>
                                <div class="glass-card p-4 space-y-2">
                                    <h3 class="text-xl font-semibold border-b border-white/10 pb-2">Notes & Instructions</h3>
                                    <textarea id="notes" rows="2" placeholder="Notes (e.g., Thank you)" class="glass-input w-full">${invoice.notes}</textarea>
                                    <textarea id="paymentInstructions" rows="3" placeholder="Payment Instructions" class="glass-input w-full">${invoice.paymentInstructions}</textarea>
                                </div>
                            </div>

                        </form>
                        
                    </div>

                    <!-- Right Panel: Live Preview & Actions -->
                    <div class="hidden md:flex md:w-1/2 flex-col bg-gray-900/50">
                        <div class="flex justify-end space-x-3 p-4 bg-gray-900/80 sticky top-0 z-10">
                            <button id="save-draft-btn" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white transition"><i class="fa-solid fa-floppy-disk mr-1"></i> Save Draft</button>
                            
                            <div class="relative group">
                                <button class="btn-primary p-2 flex items-center space-x-2">
                                    <i class="fa-solid fa-download"></i>
                                    <span>Download Options</span>
                                </button>
                                <div class="absolute right-0 mt-2 w-48 rounded-lg shadow-xl bg-gray-800/90 glass-card p-1 hidden group-hover:block z-20">
                                    <button id="download-pdf-btn" class="w-full text-left p-2 rounded-lg hover:bg-blue-600/50 transition">Download as PDF</button>
                                    <button id="download-image-btn" class="w-full text-left p-2 rounded-lg hover:bg-blue-600/50 transition">Download as Image (PNG)</button>
                                </div>
                            </div>

                            <button id="finalize-send-btn" class="btn-primary p-2 flex items-center space-x-2 bg-green-600 hover:bg-green-700">
                                <i class="fa-solid fa-paper-plane"></i>
                                <span>Finalize & Send</span>
                            </button>
                        </div>
                        <div id="invoice-preview" class="flex-grow">
                            ${renderInvoicePreview(invoice)}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderDashboard = () => {
            if (!state.settings) return `<div class="p-8 text-center">Loading Settings...</div>`;
            
            const totalInvoices = state.invoices.length;
            const paidInvoices = state.invoices.filter(i => i.status === 'Paid').length;
            const outstandingInvoices = state.invoices.filter(i => i.status !== 'Paid' && i.status !== 'Draft').length;

            return `
                <div class="p-4 md:p-8 space-y-8">
                    <h2 class="text-3xl font-bold">Welcome back, ${state.settings.companyProfile.companyName}!</h2>
                    <p class="text-gray-400">User ID: ${userId}</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-card p-6 text-center">
                            <i class="fa-solid fa-chart-line text-4xl text-blue-400 mb-3"></i>
                            <p class="text-2xl font-extrabold">${totalInvoices}</p>
                            <p class="text-gray-400">Total Invoices</p>
                        </div>
                        <div class="glass-card p-6 text-center">
                            <i class="fa-solid fa-circle-check text-4xl text-green-400 mb-3"></i>
                            <p class="text-2xl font-extrabold">${paidInvoices}</p>
                            <p class="text-gray-400">Paid Invoices</p>
                        </div>
                        <div class="glass-card p-6 text-center">
                            <i class="fa-solid fa-clock-rotate-left text-4xl text-yellow-400 mb-3"></i>
                            <p class="text-2xl font-extrabold">${outstandingInvoices}</p>
                            <p class="text-gray-400">Outstanding</p>
                        </div>
                    </div>
                    
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="startNewInvoice()" class="btn-primary"><i class="fa-solid fa-plus mr-2"></i> Create New Invoice</button>
                            <button onclick="changeView('HISTORY')" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition"><i class="fa-solid fa-file-invoice mr-2"></i> View History</button>
                        </div>
                    </div>

                </div>
            `;
        };
        
        const renderHistory = () => {
             return `
                <div class="p-4 md:p-8 space-y-8">
                    <h2 class="text-3xl font-bold">Invoice History (${state.invoices.length})</h2>
                    <div class="glass-card p-4 overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-400">
                            <thead class="text-xs uppercase bg-white/10">
                                <tr>
                                    <th scope="col" class="px-6 py-3">#</th>
                                    <th scope="col" class="px-6 py-3">Client</th>
                                    <th scope="col" class="px-6 py-3">Issue Date</th>
                                    <th scope="col" class="px-6 py-3">Due Date</th>
                                    <th scope="col" class="px-6 py-3">Total</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                    <th scope="col" class="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.invoices.map(inv => `
                                    <tr class="border-b border-white/5 hover:bg-white/5">
                                        <td class="px-6 py-4 font-medium text-white">${inv.invoiceId}</td>
                                        <td class="px-6 py-4">${inv.client.companyName || 'N/A'}</td>
                                        <td class="px-6 py-4">${inv.dateIssued}</td>
                                        <td class="px-6 py-4">${inv.dueDate}</td>
                                        <td class="px-6 py-4 font-semibold">${inv.currency} ${inv.totals.grandTotal.toFixed(2)}</td>
                                        <td class="px-6 py-4">
                                            <span class="p-1 rounded-full text-xs font-semibold ${inv.status === 'Paid' ? 'bg-green-600' : inv.status === 'Overdue' ? 'bg-red-600' : 'bg-blue-600'} text-white">${inv.status}</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <button onclick="editInvoice('${inv.docId}')" class="text-blue-400 hover:text-blue-500 mr-2"><i class="fa-solid fa-pen"></i></button>
                                            <button onclick="showModal('Action', 'Payment recorded for ${inv.invoiceId}')" class="text-green-400 hover:text-green-500"><i class="fa-solid fa-money-bill-transfer"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        const renderModal = () => {
            if (!state.modal.isVisible) return '';
            return `
                <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center">
                    <div class="glass-card p-6 w-full max-w-sm">
                        <h3 class="text-xl font-bold mb-3">${state.modal.title}</h3>
                        <p class="text-gray-300 mb-5">${state.modal.message}</p>
                        <button onclick="closeModal()" class="btn-primary w-full">Close</button>
                    </div>
                </div>
            `;
        };
        
        // --- Core Application Logic ---

        window.changeView = (view) => {
            state.currentView = view;
            updateUI();
        };

        window.startNewInvoice = () => {
            state.currentInvoice = newInvoice();
            changeView('EDITOR');
        };

        window.editInvoice = (docId) => {
            const invoiceToEdit = state.invoices.find(i => i.docId === docId);
            if (invoiceToEdit) {
                state.currentInvoice = JSON.parse(JSON.stringify(invoiceToEdit)); // Deep copy for editing
                calculateTotals(state.currentInvoice);
                changeView('EDITOR');
            } else {
                showModal('Error', 'Invoice not found.');
            }
        };

        window.closeModal = () => {
            state.modal.isVisible = false;
            updateUI();
        };

        const generateImage = () => {
            const previewElement = document.getElementById('invoice-template-area');
            if (!previewElement) {
                return showModal('Error', 'Invoice preview element not found.');
            }
            
            showModal('Generating Image...', 'Please wait while we capture the invoice as a high-quality PNG.');

            // Use html2canvas to capture the rendered invoice area
            html2canvas(previewElement, {
                scale: 2, // Higher resolution
                useCORS: true, // Handle images/logos if from another domain
                backgroundColor: null, // Transparent background if possible
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = imgData;
                link.download = `${state.currentInvoice.invoiceId || 'draft'}-invoice.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                closeModal(); // Close the "Generating" modal
                showModal('Success', 'Invoice image downloaded successfully!');
            }).catch(error => {
                console.error('Error generating image:', error);
                showModal('Error', 'Failed to generate image. See console for details.');
            });
        };

        const updateUI = () => {
            const appDiv = document.getElementById('app');
            let content = '';
            
            if (state.currentView === 'LOADING') {
                content = `<div class="flex flex-col items-center justify-center flex-grow"><i class="fa-solid fa-spinner fa-spin text-4xl text-blue-400"></i><p class="mt-4">Initializing Application...</p></div>`;
            } else if (state.currentView === 'ONBOARDING') {
                content = renderOnboarding();
            } else {
                // All other views include the navigation bar
                content += renderNav();
                content += '<main class="flex-grow">';
                if (state.currentView === 'DASHBOARD') {
                    content += renderDashboard();
                } else if (state.currentView === 'EDITOR') {
                    content += renderEditor();
                } else if (state.currentView === 'HISTORY') {
                    content += renderHistory();
                } else {
                    content += `<div class="p-8 text-center">View Not Implemented Yet: ${state.currentView}</div>`;
                }
                content += '</main>';
            }

            appDiv.innerHTML = content + renderModal();

            // Setup Onboarding Listener after rendering
            if (state.currentView === 'ONBOARDING') {
                document.getElementById('onboarding-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const companyName = document.getElementById('onboard_companyName').value;
                    const logoUrl = document.getElementById('onboard_logoUrl').value;
                    const defaultCurrency = document.getElementById('onboard_defaultCurrency').value;
                    const paymentDetails = document.getElementById('onboard_paymentDetails').value;

                    const settingsData = {
                        companyProfile: { companyName, logoUrl, taxId: 'N/A' },
                        defaultCurrency,
                        defaultPaymentTerms: 'Net 30',
                        defaultTaxRate: 0.00,
                        defaultNotes: 'Thank you for your business!',
                        paymentDetails
                    };
                    saveSettings(settingsData);
                    state.currentView = 'DASHBOARD'; // Move to dashboard upon success
                    updateUI();
                });
            }
        };

        // --- Initialization on Window Load ---
        window.onload = async () => {
            await initializeFirebase();
            setupListeners();
            updateUI(); // Initial render of LOADING state
        };

    </script>
</body>
</html>

