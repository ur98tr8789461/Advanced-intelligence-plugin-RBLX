<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleek Glassmorphic Invoice Creator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.latest/css/all.min.css">
    <!-- Load HTML2Canvas for Image/PNG Generation -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* Custom Dark Mode & Glassmorphism Styling */
        :root {
            --primary-color: #3b82f6; /* Tailwind Blue-500 */
            --dark-blue-theme: #172554; /* Custom Dark Blue */
            --text-color: #e5e7eb;
            --bg-color: #030712; /* Darkest Gray */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .glass-card {
            background-color: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }

        .glass-input {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 10px;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        .glass-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        /* Dark Mode overrides for elements inside the glass */
        .glass-card * {
            color: var(--text-color);
        }
        
        /* === PNG CAPTURE MODE (Used by html2canvas) === */
        /* Forces a reliable white background/black text state during capture */
        #invoice-template-area.is-rendering-image {
            /* Aggressively disable all complex glass effects */
            backdrop-filter: none !important;
            box-shadow: none !important;
            background-color: white !important; /* Force solid white background */
            color: black !important; /* Set text to black */
            border: none !important; /* Remove borders */
            transition: none !important; /* Disable any transition during the brief capture window */
        }
        
        /* Force all children's colors to black, overriding dark mode settings */
        #invoice-template-area.is-rendering-image * {
            color: black !important; 
        }

        /* Re-color specific elements that need distinction (e.g., status, totals) */
        #invoice-template-area.is-rendering-image .text-blue-400 { color: #3b82f6 !important; } /* Blue-500 */
        #invoice-template-area.is-rendering-image .text-yellow-400 { color: #facc15 !important; } /* Yellow-400 */
        #invoice-template-area.is-rendering-image .text-green-400 { color: #4ade80 !important; } /* Green-400 */
        
        /* Hide the logo during capture to prevent CORS errors (as before) */
        #invoice-template-area.is-rendering-image .invoice-logo {
            display: block !important; /* Display the logo, but its source must be a safe placeholder URL */
        }
        /* Ensure table lines are black on white */
        #invoice-template-area.is-rendering-image .border-b,
        #invoice-template-area.is-rendering-image .border-t,
        #invoice-template-area.is-rendering-image .border-white\/10 {
            border-color: #d1d5db !important; /* Light gray border */
        }
        
        /* --- PDF PRINT STYLES (Used by window.print()) --- */
        @media print {
            body {
                background-color: white !important;
                color: black !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important; /* Prevent scrollbars on print */
            }
            /* Hide the navigation and controls, leaving only the invoice area */
            .glass-card:not(#invoice-template-area), 
            nav, 
            .editor-controls, 
            #invoice-editor-left-panel,
            .bg-gray-900\/80 { /* Hide the save/download bar */
                display: none !important;
            }
            
            /* Make the invoice template the only visible thing, full size, no glass effect */
            #invoice-template-area {
                width: 100% !important;
                max-width: none !important;
                min-height: auto !important;
                background-color: white !important;
                backdrop-filter: none !important;
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 30px !important; /* Add padding for margin on print */
                color: black !important;
            }
            /* Ensure all invoice text is black */
            #invoice-template-area * {
                color: black !important;
            }
            /* Re-add color for status/totals */
            #invoice-template-area .text-blue-400 { color: #3b82f6 !important; }
            #invoice-template-area .text-yellow-400 { color: #facc15 !important; }
            #invoice-template-area .text-green-400 { color: #4ade80 !important; }
            
            /* Ensure borders are visible in print */
            #invoice-template-area .border-b,
            #invoice-template-area .border-t,
            #invoice-template-area .border-white\/10 {
                border-color: #d1d5db !important;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- This loading screen is temporary and should be immediately overwritten by JS -->
    <div id="app" class="flex flex-col flex-grow">
        <div class="flex flex-col items-center justify-center flex-grow">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-400"></i>
            <p class="mt-4 text-gray-400">Initializing Application...</p>
        </div>
    </div>

    <script type="module">
        
        // --- LOCAL STORAGE IMPLEMENTATION ---
        
        const STORAGE_KEY = 'invoicify_local_data';

        /** Loads all app data (settings, clients, invoices) from local storage. */
        const loadFromLocalStorage = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : { settings: null, clients: [], invoices: [] };
            } catch (e) {
                console.error("Error loading from local storage (data might be corrupt, resetting to default):", e);
                // Return default state on error to prevent load failure
                return { settings: null, clients: [], invoices: [] };
            }
        };

        /** Saves all app data (settings, clients, invoices) to local storage. */
        const saveToLocalStorage = () => {
            try {
                const dataToSave = {
                    settings: state.settings,
                    clients: state.clients,
                    invoices: state.invoices,
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Error saving to local storage", e);
            }
        };

        const initialData = loadFromLocalStorage();

        // --- Application State ---
        const state = {
            currentView: 'DASHBOARD', // Will be overridden immediately by DOMContentLoaded
            settings: initialData.settings, // Stores user settings and company profile
            clients: initialData.clients,
            invoices: initialData.invoices,
            currentInvoice: null,
            modal: {
                isVisible: false,
                title: '',
                message: ''
            }
        };

        // --- Utility Functions ---

        /** Generates a simple, universally compatible unique ID. */
        const generateUID = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
        
        /** Generates a random, unique Invoice ID based on the current year. */
        const generateInvoiceId = (invoices) => {
            const year = new Date().getFullYear();
            // Filter out 'NEW_DRAFT' and count existing for the year
            const count = invoices.filter(inv => inv.invoiceId.startsWith(`INV-${year}`)).length + 1;
            return `INV-${year}-${String(count).padStart(4, '0')}`;
        };

        /** Calculates all financial totals for the current invoice. */
        const calculateTotals = (invoice) => {
            const items = invoice.items || [];
            let subtotal = 0;
            
            items.forEach(item => {
                const total = (parseFloat(item.quantity) || 0) * (parseFloat(item.unitPrice) || 0);
                item.lineTotal = parseFloat(total.toFixed(2));
                subtotal += total;
            });
            
            const taxRate = parseFloat(invoice.totals.taxRate) || 0;
            const discountAmount = parseFloat(invoice.totals.discountAmount) || 0;

            let taxableBase = subtotal - discountAmount;
            if (taxableBase < 0) taxableBase = 0;

            const taxAmount = parseFloat((taxableBase * taxRate).toFixed(2));
            const grandTotal = parseFloat((subtotal - discountAmount + taxAmount).toFixed(2));

            invoice.totals = {
                ...invoice.totals,
                subtotal: parseFloat(subtotal.toFixed(2)),
                taxAmount: taxAmount,
                grandTotal: grandTotal,
            };
        };

        /** Resets and initializes a new invoice object. */
        const newInvoice = () => {
            const inv = {
                invoiceId: 'NEW_DRAFT',
                docId: generateUID(), // Use generateUID for a unique local ID
                status: 'Draft',
                dateIssued: new Date().toISOString().substring(0, 10),
                dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().substring(0, 10), // Net 30 default
                currency: state.settings?.defaultCurrency || 'USD',
                paymentTerms: state.settings?.defaultPaymentTerms || 'Net 30',
                client: {},
                sender: state.settings?.companyProfile || {},
                items: [{ itemId: generateUID(), description: '', quantity: 1, unit: 'Units', unitPrice: 0.00, lineTotal: 0.00 }], // Use generateUID for item ID
                totals: {
                    subtotal: 0.00,
                    discountAmount: 0.00,
                    taxRate: state.settings?.defaultTaxRate || 0.00,
                    taxAmount: 0.00,
                    grandTotal: 0.00,
                },
                design: {
                    templateStyle: 'Glassmorphism', 
                    themeColor: 'Dark Blue', 
                    mode: 'Dark'
                },
                notes: state.settings?.defaultNotes || 'Thank you for your business!',
                paymentInstructions: state.settings?.paymentDetails || '',
            };
            calculateTotals(inv);
            return inv;
        };

        /** Shows a custom modal message */
        const showModal = (title, message) => {
            state.modal = { isVisible: true, title, message };
            updateUI();
        };
        
        // --- Local Storage Data Interaction ---

        /** Saves the user's settings (used in Onboarding and Settings page) */
        const saveSettings = (settingsData) => {
            state.settings = settingsData;
            saveToLocalStorage();
            showModal('Success', 'Settings saved successfully!');
        };

        /** Saves a single invoice document (used in Editor) */
        const saveInvoice = async (invoiceData, options = { final: false }) => {
            try {
                // If it's a new final invoice, generate the final ID
                if (options.final && invoiceData.invoiceId === 'NEW_DRAFT') {
                    invoiceData.invoiceId = generateInvoiceId(state.invoices);
                    invoiceData.status = 'Sent'; // Automatically mark as sent when finalizing
                }

                // docId should always exist now thanks to newInvoice() and generateUID()
                const existingIndex = state.invoices.findIndex(i => i.docId === invoiceData.docId);

                if (existingIndex > -1) {
                    // Update existing
                    state.invoices[existingIndex] = JSON.parse(JSON.stringify(invoiceData));
                } else {
                    // Add new
                    state.invoices.push(JSON.parse(JSON.stringify(invoiceData)));
                }
                
                saveToLocalStorage();

                showModal('Success', `Invoice ${invoiceData.invoiceId} saved.`);
                state.currentInvoice = invoiceData;

                // Move to History view on final save
                if (options.final) {
                    state.currentView = 'HISTORY';
                }

                updateUI();
            } catch (error) {
                console.error("Error saving invoice:", error);
                showModal('Error', `Failed to save invoice: ${error.message}`);
            }
        };


        // --- View Rendering Logic ---

        const renderNav = () => {
            const navItems = [
                { id: 'DASHBOARD', icon: 'fa-house', label: 'Dashboard' },
                { id: 'HISTORY', icon: 'fa-file-invoice', label: 'Invoices' },
                { id: 'SETTINGS', icon: 'fa-gear', label: 'Settings' }
            ];
            
            // Render the Nav Bar for the main application
            return `
                <nav class="glass-card flex justify-between items-center p-4 sticky top-0 z-50 rounded-none rounded-b-xl">
                    <div class="flex items-center space-x-2">
                        <i class="fa-solid fa-gem text-lg text-blue-400"></i>
                        <span class="text-xl font-bold">Invoicify</span>
                    </div>
                    <div class="hidden md:flex space-x-4">
                        ${navItems.map(item => `
                            <button onclick="window.changeView('${item.id}')" class="flex items-center space-x-2 p-2 rounded-lg transition ${state.currentView === item.id ? 'bg-blue-800/50 text-white' : 'hover:bg-white/10 text-gray-300'}">
                                <i class="fa-solid ${item.icon}"></i>
                                <span>${item.label}</span>
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="window.startNewInvoice()" class="btn-primary flex items-center space-x-2">
                        <i class="fa-solid fa-plus"></i>
                        <span class="hidden sm:inline">Create Invoice</span>
                    </button>
                </nav>
            `;
        };
        
        /** Renders the settings/onboarding form. */
        const renderSettingsForm = () => {
            // Use existing settings data or default values for form inputs
            const settings = state.settings || { companyProfile: {} };
            const profile = settings.companyProfile || {};
            const isSettingsView = state.currentView === 'SETTINGS';

            return `
                <div class="p-4 md:p-8 space-y-8">
                    <h2 class="text-3xl font-bold">${isSettingsView ? 'Application Settings' : 'Welcome! Let\'s Get Started'}</h2>
                    <p class="text-gray-400">${isSettingsView ? 'Update your company and default invoice details.' : 'Please enter your core company details to begin creating invoices.'}</p>
                    <form id="onboarding-form" class="glass-card p-6 space-y-5 w-full max-w-xl mx-auto">
                        <h3 class="text-xl font-semibold mb-4 border-b border-white/10 pb-2">Company Profile</h3>
                        
                        <div>
                            <label for="onboard_companyName" class="block text-sm font-medium mb-1">Company Name *</label>
                            <input type="text" id="onboard_companyName" value="${profile.companyName || ''}" placeholder="Your Company Name" required class="glass-input w-full">
                        </div>
                        
                        <div>
                            <label for="onboard_logoUrl" class="block text-sm font-medium mb-1">Logo URL (Optional, for Invoice Header)</label>
                            <input type="url" id="onboard_logoUrl" value="${profile.logoUrl || ''}" placeholder="https://placehold.co/150x50/3b82f6/white?text=LOGO" class="glass-input w-full">
                        </div>

                        <h3 class="text-xl font-semibold mb-4 border-b border-white/10 pt-4 pb-2">Invoice Defaults</h3>

                        <div>
                            <label for="onboard_defaultCurrency" class="block text-sm font-medium mb-1">Default Currency Code</label>
                            <select id="onboard_defaultCurrency" class="glass-input w-full">
                                <option value="USD" ${settings.defaultCurrency === 'USD' ? 'selected' : ''}>USD - US Dollar</option>
                                <option value="EUR" ${settings.defaultCurrency === 'EUR' ? 'selected' : ''}>EUR - Euro</option>
                                <option value="GBP" ${settings.defaultCurrency === 'GBP' ? 'selected' : ''}>GBP - British Pound</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="onboard_paymentDetails" class="block text-sm font-medium mb-1">Payment Instructions (Bank/ACH Details)</label>
                            <textarea id="onboard_paymentDetails" rows="3" placeholder="e.g., Bank Name: ABC Bank, Account: 12345678" class="glass-input w-full">${settings.paymentDetails || ''}</textarea>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-4">
                            ${isSettingsView ? 'Save Settings' : 'Start Invoicify'}
                        </button>
                    </form>
                </div>
            `;
        };

        const renderInvoicePreview = (invoice) => {
            const { companyProfile } = state.settings || {};
            const { design } = invoice;

            let cardClass = 'glass-card border-2';
            let colorClass = design.themeColor === 'Dark Blue' ? 'bg-blue-950/20 text-gray-200' : 'bg-red-900/20 text-gray-200';
            
            // Customize based on templateStyle
            if (design.templateStyle === 'Glassmorphism') {
                cardClass = 'glass-card p-8 shadow-xl';
            } else if (design.templateStyle === 'Modern') {
                cardClass = 'bg-white/10 p-8 shadow-2xl';
            } else if (design.templateStyle === 'Sleek') {
                cardClass = 'bg-gray-900/50 p-6 shadow-lg border-l-4 border-blue-400';
            }
            
            // Use the fallback URL for the logo, which is already a placeholder and avoids CORS.
            const logoUrl = companyProfile?.logoUrl || 'https://placehold.co/150x50/3b82f6/white?text=LOGO';

            return `
                <div class="h-full overflow-y-auto p-4 md:p-8">
                    <div id="invoice-template-area" class="${cardClass} ${colorClass} mx-auto w-full max-w-3xl min-h-[800px] print:p-0">
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-10 border-b border-white/10 pb-4">
                            <div>
                                <h1 class="text-4xl font-bold text-white mb-2">INVOICE</h1>
                                <p class="text-gray-400">#${invoice.invoiceId === 'NEW_DRAFT' ? 'DRAFT - PENDING ID' : invoice.invoiceId}</p>
                                <p class="text-sm text-gray-500 mt-1">Status: <span class="${invoice.status === 'Sent' ? 'text-blue-400' : invoice.status === 'Draft' ? 'text-yellow-400' : 'text-green-400'} font-semibold">${invoice.status}</span></p>
                            </div>
                            <div class="text-right">
                                <!-- CRITICAL: Use the logo URL or fallback placeholder -->
                                ${companyProfile?.logoUrl ? `<img src="${logoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/150x50/3b82f6/white?text=LOGO';" alt="Logo" class="h-10 mb-2 inline-block invoice-logo">` : `<span class="text-xl font-extrabold text-blue-400 invoice-logo">${companyProfile?.companyName || 'YOUR COMPANY'}</span>`}
                                <p class="text-sm text-gray-400">${companyProfile?.companyName || ''}</p>
                            </div>
                        </div>

                        <!-- Details & Client Info -->
                        <div class="grid grid-cols-2 gap-4 mb-10 text-sm">
                            <div>
                                <h3 class="font-semibold text-gray-300 uppercase mb-1">Billed To:</h3>
                                <p class="font-medium">${invoice.client.companyName || 'Select/Enter Client'}</p>
                                <p class="text-gray-400">${invoice.client.contactPerson || ''}</p>
                                <p class="text-gray-400">${invoice.client.address?.street || ''}</p>
                                <p class="text-gray-400">${invoice.client.address?.city || ''}</p>
                            </div>
                            <div class="text-right">
                                <p><span class="font-semibold">Issue Date:</span> ${invoice.dateIssued || 'N/A'}</p>
                                <p><span class="font-semibold">Due Date:</span> ${invoice.dueDate || 'N/A'}</p>
                                <p><span class="font-semibold">Payment Terms:</span> ${invoice.paymentTerms}</p>
                            </div>
                        </div>

                        <!-- Line Items Table -->
                        <div class="mb-10">
                            <table class="w-full text-left text-sm">
                                <thead class="border-b border-white/20 uppercase text-gray-400">
                                    <tr>
                                        <th class="py-2">Description</th>
                                        <th class="py-2 text-right">Qty</th>
                                        <th scope="col" class="px-6 py-3">Unit Price</th>
                                        <th class="py-2 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoice.items.map(item => `
                                        <tr class="border-b border-white/5">
                                            <td class="py-2 font-medium">${item.description || 'Service Description'}</td>
                                            <td class="py-2 text-right">${item.quantity} ${item.unit}</td>
                                            <td class="py-2 text-right">${invoice.currency} ${item.unitPrice.toFixed(2)}</td>
                                            <td class="py-2 text-right font-medium">${invoice.currency} ${item.lineTotal.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Totals & Notes -->
                        <div class="flex justify-end">
                            <div class="w-full max-w-sm">
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Subtotal:</span>
                                        <span class="font-medium">${invoice.currency} ${invoice.totals.subtotal.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Discount:</span>
                                        <span class="font-medium">${invoice.currency} ${invoice.totals.discountAmount.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Tax (${(invoice.totals.taxRate * 100).toFixed(0)}%):</span>
                                        <span class="font-medium">${invoice.currency} ${invoice.totals.taxAmount.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between pt-3 border-t border-white/20 text-lg font-bold">
                                        <span>GRAND TOTAL:</span>
                                        <span class="text-blue-400">${invoice.currency} ${invoice.totals.grandTotal.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="mt-10 pt-6 border-t border-white/10 text-sm">
                            <h3 class="font-semibold text-gray-300 uppercase mb-2">Notes:</h3>
                            <p class="text-gray-400 mb-4">${invoice.notes}</p>
                            <h3 class="font-semibold text-gray-300 uppercase mb-2">Payment Instructions:</h3>
                            <p class="text-gray-400">${invoice.paymentInstructions}</p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderEditorTotalsSummary = (invoice) => {
            return `
                <h3 class="text-xl font-semibold border-b border-white/10 pb-2">Financials</h3>
                <label class="block text-sm font-medium">Discount Amount (${invoice.currency})</label>
                <input type="number" id="totals_discountAmount" value="${invoice.totals.discountAmount}" step="0.01" min="0" class="glass-input w-full">
                <label class="block text-sm font-medium">Tax Rate (%)</label>
                <input type="number" id="totals_taxRate" value="${(invoice.totals.taxRate * 100).toFixed(0)}" min="0" max="100" class="glass-input w-full">
                <div class="pt-2 border-t border-white/10 text-lg font-bold">
                    Grand Total: ${invoice.currency} ${invoice.totals.grandTotal.toFixed(2)}
                </div>
            `;
        };

        /** * Selectively updates only the invoice preview and the editor's totals box.
         * This avoids re-rendering the whole page and closing the keyboard.
         */
        const updatePreviewAndTotals = () => {
            const previewEl = document.getElementById('invoice-preview');
            if (previewEl) {
                previewEl.innerHTML = renderInvoicePreview(state.currentInvoice);
            }
            const totalsEl = document.getElementById('editor-totals-summary');
            if (totalsEl) {
                totalsEl.innerHTML = renderEditorTotalsSummary(state.currentInvoice);
            }
        };


        const renderEditor = () => {
            const invoice = state.currentInvoice;
            if (!invoice) return ``;

            // Function to add a new blank line item
            const addItem = () => {
                const newItem = {
                    itemId: generateUID(), // Use generateUID
                    description: '', quantity: 1, unit: 'Units', unitPrice: 0.00, lineTotal: 0.00
                };
                invoice.items.push(newItem);
                calculateTotals(invoice);
                updateUI(); // Immediate update on structural change
            };

            // Function to handle changes to line items
            const handleItemChange = (itemId, field, value) => {
                const item = invoice.items.find(i => i.itemId == itemId);
                if (item) {
                    item[field] = field === 'description' || field === 'unit' ? value : parseFloat(value) || 0;
                    calculateTotals(invoice);
                    updatePreviewAndTotals(); 
                }
            };

            // Function to remove a line item
            const removeItem = (itemId) => {
                invoice.items = invoice.items.filter(i => i.itemId != itemId);
                calculateTotals(invoice);
                updateUI(); // Immediate update on structural change
            };

            // Attach listeners for dynamic element manipulation
            setTimeout(() => {
                document.getElementById('add-item-btn')?.addEventListener('click', addItem);
                
                // Set up event listeners for line items
                document.querySelectorAll('.line-item-input').forEach(input => {
                    input.removeEventListener('input', handleItemChangeWrapper); 
                    input.addEventListener('input', handleItemChangeWrapper);
                });

                function handleItemChangeWrapper(e) {
                    const [field, itemId] = e.target.id.split('_'); 
                    handleItemChange(itemId, field, e.target.value);
                }


                document.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.removeEventListener('click', removeItemWrapper);
                    btn.addEventListener('click', removeItemWrapper);
                });

                function removeItemWrapper(e) {
                    const itemId = e.target.dataset.itemid || e.target.closest('button')?.dataset.itemid;
                    if (itemId) removeItem(itemId);
                }


                // Set up listeners for design controls
                document.getElementById('design-controls')?.addEventListener('click', (e) => {
                    if (e.target.dataset.template) {
                        invoice.design.templateStyle = e.target.dataset.template;
                        updateUI(); // Full redraw OK for button clicks
                    } else if (e.target.dataset.theme) {
                        invoice.design.themeColor = e.target.dataset.theme;
                        updateUI(); // Full redraw OK for button clicks
                    } else if (e.target.dataset.mode) {
                        invoice.design.mode = e.target.dataset.mode;
                        updateUI(); // Full redraw OK for button clicks
                    }
                });

                // KEYBOARD FIX: Attach listener to the entire left panel
                const leftPanel = document.getElementById('invoice-editor-left-panel');
                if (leftPanel) {
                    leftPanel.removeEventListener('input', handleCoreDataChange);
                    leftPanel.addEventListener('input', handleCoreDataChange);
                }
                
                function handleCoreDataChange(e) {
                    // Ignore inputs from line items (handled separately)
                    if (e.target.classList.contains('line-item-input')) {
                        return;
                    }

                    const field = e.target.id;
                    if (!field) return; // Ignore events from non-ID'd elements

                    if (field.startsWith('client_')) {
                        const clientField = field.substring(7);
                        if (!invoice.client.address) invoice.client.address = {};
                        if (clientField === 'street' || clientField === 'city') {
                            invoice.client.address[clientField] = e.target.value;
                        } else {
                            invoice.client[clientField] = e.target.value;
                        }
                    } else if (field.startsWith('totals_')) {
                        // Special handling for percentage input (Tax Rate)
                        if (field === 'totals_taxRate') {
                            invoice.totals[field.substring(7)] = (parseFloat(e.target.value) / 100) || 0;
                        } else {
                            invoice.totals[field.substring(7)] = parseFloat(e.target.value) || 0;
                        }
                        calculateTotals(invoice);
                    } else {
                        invoice[field] = e.target.value;
                    }
                    
                    // KEYBOARD FIX: Call the lightweight update function for ALL other fields
                    updatePreviewAndTotals(); 
                }

                // Attach Download & Save Handlers
                // *** UPDATED PDF BUTTON TO TRIGGER BROWSER PRINT DIALOG ***
                document.getElementById('download-pdf-btn')?.addEventListener('click', () => {
                    window.print();
                });
                // *********************************************************
                
                document.getElementById('download-image-btn')?.addEventListener('click', generateImage);
                document.getElementById('save-draft-btn')?.addEventListener('click', () => saveInvoice(invoice, { final: false }));
                document.getElementById('finalize-send-btn')?.addEventListener('click', () => saveInvoice(invoice, { final: true }));


            }, 0); // Run after UI update

            // Line Item Editor Structure
            const lineItemRows = invoice.items.map(item => `
                <div class="grid grid-cols-6 gap-3 mb-2 items-center">
                    <input type="text" id="description_${item.itemId}" value="${item.description}" placeholder="Description" class="line-item-input glass-input col-span-2">
                    <input type="text" id="unit_${item.itemId}" value="${item.unit}" placeholder="Unit (e.g., Hrs)" class="line-item-input glass-input">
                    <input type="number" id="quantity_${item.itemId}" value="${item.quantity}" min="0" class="line-item-input glass-input">
                    <input type="number" id="unitPrice_${item.itemId}" value="${item.unitPrice}" min="0" step="0.01" class="line-item-input glass-input">
                    <div class="text-right font-medium">${invoice.currency} ${item.lineTotal.toFixed(2)}</div>
                    <button type="button" data-itemid="${item.itemId}" class="remove-item-btn text-red-400 hover:text-red-500 transition"><i data-itemid="${item.itemId}" class="fa-solid fa-trash-can"></i></button>
                </div>
            `).join('');


            // Editor UI Layout (Switches from side-by-side on desktop to stacked on mobile)
            return `
                <!-- FIX: Ensuring mobile responsiveness -->
                <div class="flex flex-col md:flex-row flex-grow"> 
                    <!-- Top/Left: Controls & Data Entry (Full width on mobile) -->
                    <!-- KEYBOARD FIX: Added a parent container ID for the event listener -->
                    <div id="invoice-editor-left-panel" class="w-full md:w-1/2 overflow-y-auto p-4 md:p-8 space-y-8">
                        
                        <!-- 1. Design Controls -->
                        <div class="glass-card p-4 space-y-4">
                            <h3 class="text-xl font-semibold border-b border-white/10 pb-2 mb-4">Design & Theme</h3>
                            
                            <p class="font-medium text-gray-300">Style:</p>
                            <div id="design-controls" class="flex space-x-2">
                                ${['Glassmorphism', 'Modern', 'Sleek'].map(t => `
                                    <button data-template="${t}" class="p-2 rounded-lg text-sm transition ${invoice.design.templateStyle === t ? 'bg-blue-600' : 'bg-white/10 hover:bg-white/20'}">${t}</button>
                                `).join('')}
                            </div>

                            <p class="font-medium text-gray-300 pt-3">Theme Color:</p>
                            <div class="flex space-x-3">
                                <button data-theme="Dark Blue" class="w-8 h-8 rounded-full bg-blue-900 border-2 ${invoice.design.themeColor === 'Dark Blue' ? 'border-blue-400' : 'border-transparent'} transition"></button>
                                <button data-theme="Red" class="w-8 h-8 rounded-full bg-red-900 border-2 ${invoice.design.themeColor === 'Red' ? 'border-red-400' : 'border-transparent'} transition"></button>
                            </div>
                        </div>

                        <!-- 2. Client & Core Info -->
                        <div class="glass-card p-4 space-y-4">
                            <h3 class="text-xl font-semibold border-b border-white/10 pb-2">Client Details</h3>
                            <input type="text" id="client_companyName" value="${invoice.client.companyName || ''}" placeholder="Client Company Name" class="glass-input w-full">
                            <input type="text" id="client_contactPerson" value="${invoice.client.contactPerson || ''}" placeholder="Contact Person" class="glass-input w-full">
                            <input type="date" id="dateIssued" value="${invoice.dateIssued}" class="glass-input w-full">
                            <input type="date" id="dueDate" value="${invoice.dueDate}" class="glass-input w-full">
                        </div>

                        <!-- 3. Line Items Editor -->
                        <div class="glass-card p-4 space-y-4">
                            <h3 class="text-xl font-semibold border-b border-white/10 pb-2">Work Items</h3>
                            <div class="grid grid-cols-6 gap-3 mb-2 font-semibold text-sm text-gray-400">
                                <div class="col-span-2">Description</div>
                                <div>Unit</div>
                                <div>Qty</div>
                                <div>Price</div>
                                <div class="text-right">Total</div>
                                <div></div>
                            </div>
                            ${lineItemRows}
                            <button type="button" id="add-item-btn" class="flex items-center space-x-1 text-blue-400 hover:text-blue-500 transition">
                                <i class="fa-solid fa-circle-plus"></i> <span>Add Work Item</span>
                            </button>
                        </div>
                        
                        <!-- 4. Totals & Notes -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="glass-card p-4 space-y-2">
                                <!-- KEYBOARD FIX: Added an ID here so we can replace its content -->
                                <div id="editor-totals-summary">
                                    ${renderEditorTotalsSummary(invoice)}
                                </div>
                            </div>
                            <div class="glass-card p-4 space-y-2">
                                <h3 class="text-xl font-semibold border-b border-white/10 pb-2">Notes & Instructions</h3>
                                <textarea id="notes" rows="2" placeholder="Notes (e.g., Thank you)" class="glass-input w-full">${invoice.notes}</textarea>
                                <textarea id="paymentInstructions" rows="3" placeholder="Payment Instructions" class="glass-input w-full">${invoice.paymentInstructions}</textarea>
                            </div>
                        </div>

                    </div>

                    <!-- Bottom/Right Panel: Live Preview & Actions (Full width on mobile, right on desktop) -->
                    <div class="w-full md:w-1/2 flex-col bg-gray-900/50 border-t md:border-t-0 md:border-l border-white/10">
                        <div class="flex justify-end space-x-3 p-4 bg-gray-900/80 sticky top-0 z-10">
                            <button id="save-draft-btn" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white transition"><i class="fa-solid fa-floppy-disk mr-1"></i> Save Draft</button>
                            
                            <div class="relative group">
                                <button class="btn-primary p-2 flex items-center space-x-2">
                                    <i class="fa-solid fa-download"></i>
                                    <span>Download Options</span>
                                </button>
                                <div class="absolute right-0 mt-2 w-48 rounded-lg shadow-xl bg-gray-800/90 glass-card p-1 hidden group-hover:block z-20">
                                    <button id="download-pdf-btn" class="w-full text-left p-2 rounded-lg hover:bg-blue-600/50 transition">Download as PDF</button>
                                    <button id="download-image-btn" class="w-full text-left p-2 rounded-lg hover:bg-blue-600/50 transition">Download as Image (PNG)</button>
                                </div>
                            </div>

                            <button id="finalize-send-btn" class="btn-primary p-2 flex items-center space-x-2 bg-green-600 hover:bg-green-700">
                                <i class="fa-solid fa-paper-plane"></i>
                                <span>Finalize & Send</span>
                            </button>
                        </div>
                        <!-- KEYBOARD FIX: Added an ID here so we can replace its content -->
                        <div id="invoice-preview" class="flex-grow">
                            ${renderInvoicePreview(invoice)}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderDashboard = () => {
            if (!state.settings) return `<div class="p-8 text-center text-red-400">Settings not loaded. Please complete onboarding.</div>`;
            
            const totalInvoices = state.invoices.length;
            const paidInvoices = state.invoices.filter(i => i.status === 'Paid').length;
            const outstandingInvoices = state.invoices.filter(i => i.status !== 'Paid' && i.status !== 'Draft').length;

            return `
                <div class="p-4 md:p-8 space-y-8">
                    <h2 class="text-3xl font-bold">Welcome back, ${state.settings.companyProfile.companyName}!</h2>
                    <p class="text-gray-400 italic">Storage: Local Browser Storage Only</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-card p-6 text-center">
                            <i class="fa-solid fa-chart-line text-4xl text-blue-400 mb-3"></i>
                            <p class="text-2xl font-extrabold">${totalInvoices}</p>
                            <p class="text-gray-400">Total Invoices</p>
                        </div>
                        <div class="glass-card p-6 text-center">
                            <i class="fa-solid fa-circle-check text-4xl text-green-400 mb-3"></i>
                            <p class="text-2xl font-extrabold">${paidInvoices}</p>
                            <p class="text-gray-400">Paid Invoices</p>
                        </div>
                        <div class="glass-card p-6 text-center">
                            <i class="fa-solid fa-clock-rotate-left text-4xl text-yellow-400 mb-3"></i>
                            <p class="text-2xl font-extrabold">${outstandingInvoices}</p>
                            <p class="text-gray-400">Outstanding</p>
                        </div>
                    </div>
                    
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="window.startNewInvoice()" class="btn-primary"><i class="fa-solid fa-plus mr-2"></i> Create New Invoice</button>
                            <button onclick="window.changeView('HISTORY')" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition"><i class="fa-solid fa-file-invoice mr-2"></i> View History</button>
                        </div>
                    </div>

                </div>
            `;
        };
        
        const renderHistory = () => {
             return `
                <div class="p-4 md:p-8 space-y-8">
                    <h2 class="text-3xl font-bold">Invoice History (${state.invoices.length})</h2>
                    <div class="glass-card p-4 overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-400">
                            <thead class="text-xs uppercase bg-white/10">
                                <tr>
                                    <th scope="col" class="px-6 py-3">#</th>
                                    <th scope="col" class="px-6 py-3">Client</th>
                                    <th scope="col" class="px-6 py-3">Issue Date</th>
                                    <th scope="col" class="px-6 py-3">Due Date</th>
                                    <th scope="col" class="px-6 py-3">Total</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                    <th scope="col" class="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.invoices.map(inv => `
                                    <tr class="border-b border-white/5 hover:bg-white/5">
                                        <td class="px-6 py-4 font-medium text-white">${inv.invoiceId}</td>
                                        <td class="px-6 py-4">${inv.client.companyName || 'N/A'}</td>
                                        <td class="px-6 py-4">${inv.dateIssued}</td>
                                        <td class="px-6 py-4">${inv.dueDate}</td>
                                        <td class="px-6 py-4 font-semibold">${inv.currency} ${inv.totals.grandTotal.toFixed(2)}</td>
                                        <td class="px-6 py-4">
                                            <span class="p-1 rounded-full text-xs font-semibold ${inv.status === 'Paid' ? 'bg-green-600' : inv.status === 'Overdue' ? 'bg-red-600' : 'bg-blue-600'} text-white">${inv.status}</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <button onclick="window.editInvoice('${inv.docId}')" class="text-blue-400 hover:text-blue-500 mr-2"><i class="fa-solid fa-pen"></i></button>
                                            <button onclick="window.showModal('Action', 'Payment recorded for ${inv.invoiceId}')" class="text-green-400 hover:text-green-500"><i class="fa-solid fa-money-bill-transfer"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        const renderModal = () => {
            if (!state.modal.isVisible) return '';
            return `
                <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                    <div class="glass-card p-6 w-full max-w-sm">
                        <h3 class="text-xl font-bold mb-3">${state.modal.title}</h3>
                        <p class="text-gray-300 mb-5 break-words">${state.modal.message}</p>
                        <button onclick="window.closeModal()" class="btn-primary w-full">Close</button>
                    </div>
                </div>
            `;
        };
        
        // --- Core Application Logic ---

        // Attaching core functions to window for onclick handlers in HTML
        window.changeView = (view) => {
            state.currentView = view;
            updateUI();
        };

        window.startNewInvoice = () => {
            if (!state.settings || !state.settings.companyProfile?.companyName) {
                return showModal('Setup Required', 'Please complete your company settings first before creating an invoice.');
            }
            state.currentInvoice = newInvoice();
            window.changeView('EDITOR');
        };

        window.editInvoice = (docId) => {
            const invoiceToEdit = state.invoices.find(i => i.docId === docId);
            if (invoiceToEdit) {
                state.currentInvoice = JSON.parse(JSON.stringify(invoiceToEdit)); // Deep copy for editing
                calculateTotals(state.currentInvoice);
                window.changeView('EDITOR');
            } else {
                window.showModal('Error', 'Invoice not found.');
            }
        };

        window.showModal = showModal;

        window.closeModal = () => {
            state.modal.isVisible = false;
            updateUI();
        };

        // IMAGE GENERATION FIX (Final, Aggressive Fix with Timing Control)
        const generateImage = () => {
            if (typeof html2canvas === 'undefined') {
                return window.showModal('Error', 'Image generation library (html2canvas) failed to load.');
            }
            
            const previewElement = document.getElementById('invoice-template-area');
            if (!previewElement) {
                return window.showModal('Error', 'Invoice preview element not found.');
            }
            
            window.showModal('Generating Image...', 'Please wait while we capture the invoice as a high-quality PNG. (The design is temporarily simplified for capture)');

            // 1. Force "Print Mode" class to reset styling
            previewElement.classList.add('is-rendering-image');

            // 2. Use requestAnimationFrame to ensure the browser has time to apply the CSS changes
            requestAnimationFrame(() => {
                // 3. Add a small delay (10ms) to ensure reflow is complete before capture
                setTimeout(() => {
                    html2canvas(previewElement, {
                        scale: 2, // Higher resolution
                        useCORS: true, 
                        backgroundColor: 'white', // Explicitly set background to white for PNG conversion
                        logging: false 
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const link = document.createElement('a');
                        link.href = imgData;
                        link.download = `${state.currentInvoice.invoiceId || 'draft'}-invoice.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        window.closeModal(); // Close the "Generating" modal
                        window.showModal('Success', 'Invoice image downloaded successfully!');

                    }).catch(error => {
                        console.error('Error generating image:', error);
                        // Show the actual error message (or 'undefined' if still generic)
                        const errorMessage = error.message || "undefined";
                        window.showModal('Error Generating Image', `Failed to generate image. The error was: "${errorMessage}". This is often due to complex rendering effects.`);
                    }).finally(() => {
                        // CRITICAL: ALWAYS remove the class to revert to glassmorphic design
                        previewElement.classList.remove('is-rendering-image');
                    });
                }, 10); // 10ms delay to allow render
            });
        };

        /** * The main UI rendering function. This re-draws the entire application.
         * It is HEAVY and should only be called for major view changes (e.g., changing pages).
         */
        const updateUI = () => {
            const appDiv = document.getElementById('app');
            if (!appDiv) {
                console.error("Critical Error: #app element not found.");
                return;
            }
            
            let content = '';
            
            // Only render full application views (Nav + Content)
            if (['DASHBOARD', 'EDITOR', 'HISTORY', 'SETTINGS'].includes(state.currentView)) {
                content += renderNav();
                content += '<main class="flex-grow">';
                if (state.currentView === 'DASHBOARD') {
                    content += renderDashboard();
                } else if (state.currentView === 'EDITOR') {
                    content += renderEditor();
                } else if (state.currentView === 'HISTORY') {
                    content += renderHistory();
                } else if (state.currentView === 'SETTINGS') {
                    content += renderSettingsForm(); 
                }
                content += '</main>';
            } else if (state.currentView === 'ONBOARDING') {
                content = renderSettingsForm(); 
            } else {
                // Fallback for an unknown view state
                content = `<div class="flex flex-col items-center justify-center flex-grow p-8 text-red-400">
                    <i class="fa-solid fa-triangle-exclamation text-4xl mb-4"></i>
                    <p>Unknown view state: ${state.currentView}. Please refresh.</p>
                </div>`;
            }


            appDiv.innerHTML = content + renderModal();

            // Setup Onboarding/Settings Form Listener after rendering
            if (state.currentView === 'ONBOARDING' || state.currentView === 'SETTINGS') {
                document.getElementById('onboarding-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const companyName = document.getElementById('onboard_companyName').value;
                    const logoUrl = document.getElementById('onboard_logoUrl').value;
                    const defaultCurrency = document.getElementById('onboard_defaultCurrency').value;
                    const paymentDetails = document.getElementById('onboard_paymentDetails').value;

                    const settingsData = {
                        companyProfile: { companyName, logoUrl, taxId: 'N/A' },
                        defaultCurrency,
                        defaultPaymentTerms: 'Net 30',
                        defaultTaxRate: state.settings?.defaultTaxRate || 0.00, // Preserve previous tax rate if it exists
                        defaultNotes: state.settings?.defaultNotes || 'Thank you for your business!', // Preserve previous notes
                        paymentDetails
                    };
                    saveSettings(settingsData);
                    state.currentView = 'DASHBOARD'; // Move to dashboard upon success
                    updateUI();
                });
            }
        };

        // --- Initialization on DOM Content Load ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Determine initial view: if settings are incomplete, go to ONBOARDING. Otherwise, DASHBOARD.
                const needsOnboarding = !state.settings || !state.settings.companyProfile || !state.settings.companyProfile.companyName;

                if (needsOnboarding) {
                    state.currentView = 'ONBOARDING';
                    console.log("App Init: Starting Onboarding.");
                } else {
                    state.currentView = 'DASHBOARD';
                    console.log("App Init: Starting Dashboard.");
                }
                
                // Immediately call updateUI to overwrite the initial loading content
                updateUI();
            } catch (error) {
                console.error("FATAL APP INITIALIZATION ERROR:", error);
                const appDiv = document.getElementById('app');
                if (appDiv) {
                    // Display a human-readable error if the script crashes during init
                    appDiv.innerHTML = `<div class="flex flex-col items-center justify-center flex-grow p-8 text-red-500">
                        <h2 class="text-2xl font-bold">App Startup Failed!</h2>
                        <p class="mt-2">A critical error occurred while starting the application. Please check the browser console for specific details (F12 or Cmd+Option+J).</p>
                    </div>`;
                }
            }
        });

    </script>
</body>
</html>

